%%% -------------------------------------------------------------------
%%% @author  : Joq Erlang
%%% @doc: : 
%%% Created :
%%% Node end point  
%%% Creates and deletes Pods
%%% 
%%% API-kube: Interface 
%%% Pod consits beams from all services, app and app and sup erl.
%%% The setup of envs is
%%% -------------------------------------------------------------------
-module(cl_test).   
 
-export([start/0]).
%% --------------------------------------------------------------------
%% Include files
%% --------------------------------------------------------------------
-define(OpsNodeName,"ops").
-define(OpsCookie,"ops").

-define(ClId_1,"c1").
-define(ClCookieStr_1,"cookie_c1").
-define(ClNumPods_1,5).
%-define(ClNodeName_1,"c_1").

-define(ClCookie_1,list_to_atom(?ClCookieStr_1)).
-define(ClNodeC100_1,list_to_atom(?ClNodeName_1++"@"++"c100")).
-define(ClNodeC200_1,list_to_atom(?ClNodeName_1++"@"++"c200")).
%-define(ClWorkesNodeName_1,["w_c1_1","w_c1_2","w_c1_3","w_c1_4"]).

-define(HostNames,["c100","c200","c201"]).




%% --------------------------------------------------------------------
%% Function: available_hosts()
%% Description: Based on hosts.config file checks which hosts are avaible
%% Returns: List({HostId,Ip,SshPort,Uid,Pwd}
%% --------------------------------------------------------------------
start()->
   
    ok=setup(),

    %% Create a new cluster 
    ClusterId=?ClId_1,
    ClusterNodeName=?ClId_1,
    ClusterDir=?ClId_1++".dir",
    ClusterCookie=?ClCookieStr_1,
    NumPodsPerHost=?ClNumPods_1,
    HostNames=?HostNames,

   % ClusterNodes=[list_to_atom(ClusterNodeName++"@"++HostName)||HostName<-HostNames],
    PodNodeNames=[ClusterId++"_"++integer_to_list(N)||N<-lists:seq(0,NumPodsPerHost)],
  
  
    % Start new cluster nodes
    StartR=[cluster:create_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)||HostName<-HostNames],
    cluster:connect(HostNames,ClusterNodeName,ClusterCookie),
    ['c1@c100','c1@c200','c1@c201']=cluster:availble(HostNames,ClusterNodeName,ClusterCookie),
    []=cluster:not_availble(HostNames,ClusterNodeName,ClusterCookie),
   
    
    %% Start workernodes 
    PodArgs=" -setcookie "++ClusterCookie,
    PodInfo=[{list_to_atom(ClusterNodeName++"@"++HostName),ClusterCookie,HostName,PodNodeName,filename:join(ClusterDir,PodNodeName),PodArgs,list_to_atom(PodNodeName++"@"++HostName)}||PodNodeName<-PodNodeNames,HostName<-HostNames],
  
    _PodStart=[pod:create(ClusterNode,ClusterCookie,HostName,PodNodeName,PodDir,PodArgs)||{ClusterNode,ClusterCookie,HostName,PodNodeName,PodDir,PodArgs,_PodNode}<-PodInfo],
  
    ['c1_0@c100','c1_0@c200','c1_1@c100','c1_0@c201','c1_1@c200','c1_2@c100',
     'c1_1@c201','c1_2@c200','c1_3@c100','c1_2@c201','c1_3@c200','c1_4@c100',
     'c1_3@c201','c1_4@c200','c1_5@c100','c1_4@c201','c1_5@c200']=pod:available(HostNames,ClusterNodeName,ClusterCookie),

    
    
    %% load start application 
    Appl="sd",
    SourceDir="/home/joq62/erlang/infra_2/sd/ebin",

    PodNode='c1_0@c100',
    PodDir="c1_0",
    ApplDir=filename:join([ClusterDir,PodDir,Appl]),
         
    ok=service:load(PodNode,ClusterCookie,Appl,SourceDir,ApplDir),
    ok=service:start(PodNode,ClusterCookie,Appl),
    pong=dist_lib:cmd(PodNode,ClusterCookie,sd,ping,[],5000),
    timer:sleep(3000),
    ok=service:stop(PodNode,ClusterCookie,Appl),
    {badrpc,_}=dist_lib:cmd(PodNode,ClusterCookie,sd,ping,[],5000),
    service:unload(PodNode,ClusterCookie,ApplDir),
    false=dist_lib:cmd(c1@c100,ClusterCookie,filelib,is_dir,[ApplDir],5000),

    
    

  %  [true,true,true]=[delete_cluster_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)||HostName<-HostNames],
    
    
 
    %% Clean up
    
  

    init:stop(),
    ok.


%% --------------------------------------------------------------------
%% Function: available_hosts()
%% Description: Based on hosts.config file checks which hosts are avaible
%% Returns: List({HostId,Ip,SshPort,Uid,Pwd}
%% --------------------------------------------------------------------
new_cluster_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)->
    Result=case dist_lib:start_node(HostName,ClusterNodeName,ClusterCookie," -detached  ") of
	       {error,Reason}->
		   {error,[Reason,HostName,ClusterNodeName,ClusterCookie]};
	       true ->
		   ClusterNode=list_to_atom(ClusterNodeName++"@"++HostName),
		   dist_lib:rmdir_r(ClusterNode,ClusterCookie,ClusterDir),
		   case dist_lib:mkdir(ClusterNode,ClusterCookie,ClusterDir) of
		       {error,Reason}->
			   {error,[Reason,HostName,ClusterNodeName,ClusterCookie]};
		       ok->
			   case dist_lib:cmd(ClusterNode,ClusterCookie,filelib,is_dir,[ClusterDir],5000) of
			       false->
				   {error,[cluster_dir_eexists,ClusterDir,HostName,ClusterNodeName,ClusterCookie]};
			       true->
				   {ok,{HostName,ClusterNodeName,ClusterNode,ClusterCookie,ClusterDir}}
			   end
		   end
	   end,
    Result.

new_cluster_nodes([],_,_,_,Acc)->
    ErrorList=[{error,Reason}||{error,Reason}<-Acc],
    Result=case ErrorList of
	       []->
		   R=[L||{ok,L}<-Acc],
		   {ok,R};
	       ErrorList->
		   {error,ErrorList}
	   end,	       
    Result;

new_cluster_nodes([HostName|T],ClusterNodeName,ClusterCookie,ClusterDir,Acc) ->
    NewAcc=[new_cluster_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)|Acc],
    new_cluster_nodes(T,ClusterNodeName,ClusterCookie,ClusterDir,NewAcc).

%% --------------------------------------------------------------------
%% Function: available_hosts()
%% Description: Based on hosts.config file checks which hosts are avaible
%% Returns: List({HostId,Ip,SshPort,Uid,Pwd}
%% --------------------------------------------------------------------

delete_cluster_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)->
    ClusterNode=list_to_atom(ClusterNodeName++"@"++HostName),
    dist_lib:rmdir_r(ClusterNode,ClusterCookie,ClusterDir),
    dist_lib:stop_node(HostName,ClusterNodeName,ClusterCookie).

%% --------------------------------------------------------------------
%% Function: available_hosts()
%% Description: Based on hosts.config file checks which hosts are avaible
%% Returns: List({HostId,Ip,SshPort,Uid,Pwd}
%% --------------------------------------------------------------------


setup()->
    ok=application:start(ops),
    ClusterNodeName=?ClId_1,
    ClusterDir=?ClId_1++".dir",
    ClusterCookie=?ClCookieStr_1,
    [true,true,true]=[cluster:delete_node(HostName,ClusterNodeName,ClusterCookie,ClusterDir)||HostName<-?HostNames],

    ok.
